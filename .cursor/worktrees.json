{
  "setup-worktree-unix": [
    "COORD_PARENT='..'",
    "NOW=$(date +%s)",
    "find \"$COORD_PARENT\" -maxdepth 1 -type d -name '.coord-*' -mmin +60 -exec rm -rf {} + 2>/dev/null || true",
    "SESSION=''",
    "for dir in $COORD_PARENT/.coord-*; do",
    "  if [ -d \"$dir\" ]; then",
    "    CREATED=$(stat -c %W \"$dir\" 2>/dev/null || stat -f %B \"$dir\" 2>/dev/null || echo 0)",
    "    AGE=$((NOW - CREATED))",
    "    if [ $AGE -lt 10 ]; then",
    "      SESSION=$(basename \"$dir\" | sed 's/^\\.coord-//')",
    "      break",
    "    fi",
    "  fi",
    "done",
    "if [ -z \"$SESSION\" ]; then",
    "  SESSION=\"s-$(date +%Y%m%d%H%M%S)-$$\"",
    "fi",
    "COORD_DIR=\"$COORD_PARENT/.coord-$SESSION\"",
    "mkdir -p \"$COORD_DIR\"",
    "CURRENT_WORKTREE=$(pwd)",
    "for claim in \"$COORD_DIR\"/task-*.json; do",
    "  if [ -f \"$claim\" ]; then",
    "    WORKTREE=$(grep -o '\"worktree\":\"[^\"]*\"' \"$claim\" | cut -d'\"' -f4)",
    "    if [ -n \"$WORKTREE\" ] && [ ! -d \"$WORKTREE\" ]; then",
    "      rm -f \"$claim\"",
    "    fi",
    "  fi",
    "done",
    "TASK_NUM=0",
    "for i in 1 2 3 4 5 6 7 8; do",
    "  LOCK_DIR=\"$COORD_DIR/task-$i.lock\"",
    "  CLAIM_FILE=\"$COORD_DIR/task-$i.json\"",
    "  if mkdir \"$LOCK_DIR\" 2>/dev/null; then",
    "    if [ ! -f \"$CLAIM_FILE\" ]; then",
    "      TASK_NUM=$i",
    "      echo \"{\\\"task\\\":$i,\\\"worktree\\\":\\\"$CURRENT_WORKTREE\\\",\\\"claimed_at\\\":\\\"$(date -Iseconds)\\\",\\\"pid\\\":$$}\" > \"$CLAIM_FILE\"",
    "      rmdir \"$LOCK_DIR\"",
    "      break",
    "    fi",
    "    rmdir \"$LOCK_DIR\"",
    "  fi",
    "  sleep 0.05",
    "done",
    "echo \"$TASK_NUM\" > .agent-id",
    "echo \"$SESSION\" > .session-id"
  ]
}